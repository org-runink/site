name: Generate Blog Article

on:
  # Trigger when issue is opened with 'blog-request' label
  issues:
    types: [opened, labeled]
  # Keep repository_dispatch for Slack webhook integration
  repository_dispatch:
    types: [generate_blog]
  # Keep manual trigger as fallback
  workflow_dispatch:
    inputs:
      topic:
        description: "Blog topic to generate"
        required: true
        type: string

jobs:
  generate-blog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Blog Generator Image
        run: docker pull ghcr.io/org-runink/blogen:latest

      - name: Ensure output directories exist
        run: |
          mkdir -p content/blog
          mkdir -p static/images/blog

      - name: Extract topic
        id: topic
        run: |
          # Check if triggered by issue
          if [ "${{ github.event_name }}" == "issues" ]; then
            # Only proceed if issue has 'blog-request' label
            LABELS='${{ toJSON(github.event.issue.labels.*.name) }}'
            if echo "$LABELS" | grep -q "blog-request"; then
              # Use issue title as topic
              TOPIC="${{ github.event.issue.title }}"
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            else
              echo "Issue does not have 'blog-request' label, skipping..."
              exit 0
            fi
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            TOPIC="${{ github.event.client_payload.topic }}"
          else
            TOPIC="${{ inputs.topic }}"
          fi

          echo "topic=$TOPIC" >> $GITHUB_OUTPUT
          echo "slug=$(echo '$TOPIC' | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')" >> $GITHUB_OUTPUT

      - name: Run Blog Generation with Docker
        id: blog_gen
        run: |
          # Run blog generation using Docker
          docker run --rm \
            -v ${{ github.workspace }}/content:/app/content \
            -v ${{ github.workspace }}/static:/app/static \
            -e TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }} \
            ghcr.io/org-runink/blogen:latest \
            --content-dir /app/content/blog \
            --image-dir /app/static/images/blog \
            -t "${{ steps.topic.outputs.topic }}"

      - name: Validate article quality
        run: |
          SLUG="${{ steps.topic.outputs.slug }}"
          ARTICLE_FILE="content/blog/${SLUG}.md"

          # Check frontmatter exists
          if ! grep -q "^---$" "$ARTICLE_FILE"; then
            echo "‚ùå Invalid frontmatter"
            exit 1
          fi

          # Check required fields
          for field in title description slug author date tags; do
            if ! grep -q "^${field}:" "$ARTICLE_FILE"; then
              echo "‚ùå Missing required field: $field"
              exit 1
            fi
          done

          # Check minimum content length (should be substantial)
          WORD_COUNT=$(wc -w < "$ARTICLE_FILE")
          if [ "$WORD_COUNT" -lt 800 ]; then
            echo "‚ùå Article too short: $WORD_COUNT words (minimum 800)"
            exit 1
          fi

          echo "‚úÖ Article validation passed"
          echo "   Word count: $WORD_COUNT"

      - name: Extract LinkedIn Posts
        id: linkedin
        run: |
          SLUG="${{ steps.topic.outputs.slug }}"
          TOPIC="${{ steps.topic.outputs.topic }}"
          BLOG_URL="https://www.runink.org/blog/${SLUG}/"

          # Create LinkedIn company page post
          cat << 'COMPANY_EOF' >> $GITHUB_OUTPUT
          company_post<<EOF
          üöÄ New insight: ${TOPIC}

          We've just published a new article exploring ${TOPIC}. Discover key insights and practical takeaways.

          Read more: ${BLOG_URL}

          #TechBlog #Innovation #KnowledgeSharing
          EOF
          COMPANY_EOF

          # Create LinkedIn personal repost
          cat << 'PERSONAL_EOF' >> $GITHUB_OUTPUT
          personal_post<<EOF
          üí° Excited to share our latest article on ${TOPIC}!

          Check it out and let me know your thoughts: ${BLOG_URL}

          #TechInsights #Learning
          EOF
          PERSONAL_EOF

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "üìù Add blog: ${{ steps.topic.outputs.topic }}"
          branch: "blog-auto/${{ steps.topic.outputs.slug }}"
          title: "üìù Blog: ${{ steps.topic.outputs.topic }}"
          body: |
            This PR adds a new blog post generated by AI.

            **Topic:** ${{ steps.topic.outputs.topic }}
            **Triggered by:** ${{ github.event_name == 'issues' && format('Issue #{0}', steps.topic.outputs.issue_number) || 'Manual trigger' }}

            ## Files Added
            - `content/blog/${{ steps.topic.outputs.slug }}.md`
            - `static/images/blog/${{ steps.topic.outputs.slug }}.png`

            Please review the content and diagrams before merging.
          labels: "automated-content"

      - name: Comment on issue (success)
        if: success() && github.event_name == 'issues' && steps.topic.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const slug = '${{ steps.topic.outputs.slug }}';
            const prNumber = '${{ steps.create_pr.outputs.pull-request-number }}';
            const prUrl = '${{ steps.create_pr.outputs.pull-request-url }}';

            let message = `‚úÖ **Blog Article Generated Successfully!**\n\nüìÅ **Files Generated:**\n- \`content/blog/${slug}.md\`\n- \`static/images/blog/${slug}.png\`\n\n`;

            if (prNumber) {
              message += `üîÄ **Pull Request Created:** #${prNumber}\n${prUrl}\n\nPlease review and merge the PR to publish the article.`;
            } else {
              message += `‚úÖ **Changes Committed Directly**\nüîó **Preview:** https://www.runink.org/blog/${slug}/\n\nThe site will be deployed shortly.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.topic.outputs.issue_number }},
              body: message
            });

            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.topic.outputs.issue_number }},
              state: 'closed',
              labels: ['blog-request', 'completed']
            });

      - name: Comment on issue (failure)
        if: failure() && github.event_name == 'issues' && steps.topic.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.topic.outputs.issue_number }},
              body: `‚ùå **Blog Generation Failed**\n\n‚ö†Ô∏è Please check the GitHub Actions logs for details:\nhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nKeeping this issue open for retry.`
            });

      - name: Send LinkedIn Post Suggestions to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            TOPIC="${{ steps.topic.outputs.topic }}"
            SLUG="${{ steps.topic.outputs.slug }}"
            BLOG_URL="https://www.runink.org/blog/${SLUG}/"
            PR_URL="${{ steps.create_pr.outputs.pull-request-url }}"
            
            COMPANY_POST='${{ steps.linkedin.outputs.company_post }}'
            PERSONAL_POST='${{ steps.linkedin.outputs.personal_post }}'
            
            # Send to Slack
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d "{
              \"text\": \"üìù New Blog Published - LinkedIn Promotion Ready\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üìù New Blog Article Ready for Promotion\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Topic:*\n${TOPIC}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Blog URL:*\n<${BLOG_URL}|View Article>\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*PR for Review:*\n<${PR_URL}|View Pull Request>\"
                  }
                },
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*üì¢ LinkedIn Company Page Post:*\n\\\`\\\`\\\`${COMPANY_POST}\\\`\\\`\\\`\"
                  }
                },
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*üîÅ Your Personal Repost Message:*\n\\\`\\\`\\\`${PERSONAL_POST}\\\`\\\`\\\`\"
                  }
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"‚úèÔ∏è Feel free to customize these messages before posting!\"
                    }
                  ]
                }
              ]
            }"
          fi
